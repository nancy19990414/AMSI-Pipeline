# Welcome to the Automated Magnetic Source Imaging (AMSI) Repository!

AMSI repository is a package that provides source codes to produce the figures of the article "Artificial intelligence enables automated detection and localization of epileptic sources from magnetoencephalography" and to perform the main functions of this AMSI platform including:

* Automated MEG-MRI coregistration
* IED classification and peak detection
* IED clustering
* Source localization

Currently, source codes for AMSI involve MATLAB and PYTHON languages.

## Table of Contents

* [Prerequisites](#prerequisites)
* [Introduction](#introduction-for-folder)
* [Getting Example Data from AMSI Dataset](#getting-example-data)
* [Running the Core Functions on Example Data](#running-core-functions)
  * [Preprocessing](#Preprocessing)
  * [Automated MRI-MEG coregistration](#Coregistration)
  * [IED detection and peak detection](#IED-DL-model)
  * [IED clustering](#Clustering-analysis)
  * [Performing MSI](#MSI)
  * [Generating report](#The-report)
  * [AMSI demo](#Demo)
* [Others](#Others)

-----

<a id="prerequisites"></a>

## Prerequisites

1. A 64-bit Linux Operating System
2. MATLAB version 2018 or later
3. Brainstorm available at <https://neuroimage.usc.edu/brainstorm/>
4. SPM12 available at <https://www.fil.ion.ucl.ac.uk/spm/>
5. Fieldtrip available at <https://www.fieldtriptoolbox.org/>
6. MNE-Python available at <https://mne.tools/stable/index.html>

-----

<a id="introduction-for-folder"></a>

## Introduction

Please read the following instructions to understand the data and code functions contained in each folder.

1. Preprocessing. The `0-Preprocessing` folder contains the `meg_preprocessing.py` file for preprocessing MEG data.

2. MEG-MRI coregistration. The `1-MEG-MRI-coregistration` folder contains the transformation matrices data of automated and manual coregistration for calculating the differences between these two methods. Users can reproduce the Figure 2 of AMSI article.

3. IED classification and peak detection. The `2-IED-detection` folder contains the testing results from eEMS-Net model (i.e., EMS-Net and PKD-NET). Seven runs of cross-validation experiments were performed to evaluate the performance of IED classification and peak detection model. This folder also includes the codes for PKD-Net model training and testing. More information for EMS-Net is only available upon request due to patent protection or refer to the paper 10.1109/TMI.2019.2958699. Users can reproduce the Figure S1 and Table S1 of AMSI article.

4. IED clustering analysis. The `3-Clustering` folder contains the source codes to perform perceptual hash and unsupervised hierarchical clustering algorithms for detected IED epochs. Users can reproduce the Figure 4 and Table S2 of AMSI article.

5. Validation of MSI module in AMSI. The `4-MSI-validation-544IEDs` folder contains the source codes to compute the Dmin and concordance metrics from MSI results and SEEG findings. Users can reproduce the Figure 5 and Figure S3 of AMSI article.

6. Automated report. The `5-report` folder contains the autogenerated reports of the sample data.

-----

<a id="getting-example-data"></a>

## Getting Example Data from AMSI Dataset

The anonymized MEG data and MRI data for patients from Peking University (i.e., Dataset B) are released in the OpenNeuro repository (<https://openneuro.org/datasets/ds004248>). The imaging data from Sanbo Brain Hospital (i.e., Dataset A) is available upon request.

-----

<a id="running-core-functions"></a>

## Running the Core Functions on Example Data

<a id="Preprocessing"></a>

### Preprocessing

We provide a series of preprocessing functions including filtering, ECG/EOG artifact removal, and bad segments rejection in the `meg_preprocessing.py` file.

<a id="Coregistration"></a>

### Automated MRI-MEG coregistration

We use the following functions to compute the evaluation metrics (registration error, translation and rotation parameters) for coregistration:

* `do_pair_Ttest_and_Pearson_corr.m`
* `do_registration_error_calculation.m`
* `do_translation_rotation_calculation.m`

Automated MRI-MEG coregistration is based on a pattern recognition-based autolabelling method to label three fiducials and then followed by the iterative closest point (ICP) algorithm to make the headshape points closer to scale. Users need to prepare MEG and MRI files (download from [here]) as the input of auto-labelling method, and run the `${AMSIPIPEDIR}/1-MRI-MEG-coregistration/do_autolabelling.m` file in MATLAB.

<a id="IED-DL-model"></a>

### IED detection and peak detection

PKD-Net model based on U-Net has been performed to detect the peak of IED epoch, which is located in the `${AMSIPIPEDIR}/2-IED-detection/PKD_Net` directory.

* The main function refers to the `${AMSIPIPEDIR}/2-IED-detection/main_Peak_detection.py` file.
* The PKD-Net model framework sees in the `${AMSIPIPEDIR}/2-IED-detection/PKD_Net/net` folder.

<a id="Clustering-analysis"></a>

### IED clustering

Clustering analysis includes 3 parts: an image perceptual hash algorithm to extract and encode the temporal-spatial feature; an unsupervised hierarchical clustering algorithm to sort IED epochs; a local outlier factor algorithm to remove outliers.
These PYTHON scripts for clustering analysis are named as follow, and located in the `${AMSIPIPEDIR}/3-Clustering` directory:

* `mainPhash.py`
* `plot_cluster_v2_xw.py`
* `dip_fitting.py`

The `processed_data.rar` is the package that provides input data. We only released one example data in this folder due to memory limit. The `results_pic` folder contains the output results for this input example. See [here] for the full input data (`Input data for clustering`) to be used in `mainPhash.py` file.

The requirements files for running clustering analysis are listed as follow, and also located in the `${AMSIPIPEDIR}/3-Clustering` directory:

* `amsi-conda-requirements.txt`
* `amsi-pip-requirements.txt`
* `amsi.yml`

<a id="MSI"></a>

### Performing MSI

Dipole fitting, the methods of the L2-norm family, such as weighted minimum L2-norm estimation (wMNE), standardized low resolution tomography (sLORETA), and dSPM, the methods of the L1-norm family, such as enhanced fast vector-based spatiotemporal analysis (eFast-VESTAL) and spatiotemporal unifying tomography (STOUT), linearly constrained minimum variance (LCMV) beamformer and multiple signal classification (MUSIC) methods, are all included in the source analysis module of AMSI for IED localization. Please see the `${AMSIPIPEDIR}/4-MSI-validation-544IEDs/source algorithms` directory.

Additionallyï¼Œwe include the following functions to compute evaluation metrics for validating the accuracy of source algorithms:

* `do_compute_EP_Concordance_forPKU.m`
* `do_compute_EP_Dmin_forPKU`

We also sort the results of MSI in the `${AMSIPIPEDIR}/4-MSI-validation-544IEDs/` folder as the input of abovementioned functions:

* The `${AMSIPIPEDIR}/4-MSI-validation-544IEDs/electrode_coor` folder offers the coordinates of patients' SEEG electrodes.
* The `${AMSIPIPEDIR}/4-MSI-validation-544IEDs/results_PKU_fsllabel` folder offers the patients' MSI results in individual native space.
* The `${AMSIPIPEDIR}/4-MSI-validation-544IEDs/results_PKU_fsllabel` folder offers the patients' MSI results in normalization MNI space.

<a id="The-report"></a>

### Generating report

We provide the autogenerated reports of three examples and the python project of `ReportAutogeneration` for users to generate the html report based on existing results. Please see the `${AMSIPIPEDIR}/5-Report/ReportAutogeneration` folder. Try to run `report.py` file in the python environment.

<a id="Demo"></a>

### AMSI demo

We are applying to the National Medical Products Administration (NMPA) for a license so that the AMSI platform can be approved for medical device software; thus, we only use the AMSI demonstration model at http://ynyy.site:5000/amsi-demo to show the running process of sample data. Otherwise, please contact the corresponding author Prof. Jia-Hong Gao (jgao@pku.edu.cn) for more information regarding a clinical demonstration.

At the AMSI-demo website:

* `Sample 1` is Patient/Subject 03 of AMSI Dataset B.
* `Sample 2` is Patient/Subject 11 of AMSI Dataset B.
* `Sample 3` is Patient/Subject 10 of AMSI Dataset B.

-----

<a id="Others"></a>

## Others

More scripts and data descriptions of AMSI platform are available upon request. If you have any issues, please email Dr. Zheng (lilyzheng@pku.edu.cn), we are willing to help you to solve your problem.
Happy researching!

[here]: https://openneuro.org/datasets/ds004248
